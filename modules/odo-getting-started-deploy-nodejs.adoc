// Module included in the following assemblies:
//
// * cli_reference/developer_cli_odo/getting-started-with-odo/odo-getting-started-nodejs.adoc

:_content-type: Procedure
[id="odo-getting-started-deploy-nodejs_{context}"]

= Deploying your Node.js application

Use the `odo deploy` command to deploy your application.

.Prerequisites
* You have sample code for a Node.js application.
* You have logged in to your {product-title} cluster and created a project.
* You have initialized your application with `odo init`.
* You have started developing your application with `odo dev`.
* You have logged in to your image registry.
* You have configured the container build platform.

.Procedure
. *Containerize the application:* To deploy your application, you must containerize it to build and push it to a registry. Create the following Dockerfile in the same directory:
+
.Sample Dockerfile
[source, terminal]
----
# Sample copied from https://github.com/nodeshift-starters/devfile-sample/blob/main/Dockerfile

# Install the app dependencies in a full Node docker image
FROM registry.access.redhat.com/ubi8/nodejs-14:latest

# Copy package.json and package-lock.json
COPY package*.json ./

# Install app dependencies
RUN npm install --production

# Copy the dependencies into a Slim Node docker image
FROM registry.access.redhat.com/ubi8/nodejs-14-minimal:latest

# Install app dependencies
COPY --from=0 /opt/app-root/src/node_modules /opt/app-root/src/node_modules
COPY . /opt/app-root/src

ENV NODE_ENV production
ENV PORT 3000
----

. *Modify the Devfile:* Edit the `devfile.yaml` and add the appropriate deployment code:
+
[WARNING]
====
When copying and pasting to `devfile.yaml`, verify that the lines you insert are correctly indented.
====
.. `odo deploy` uses Devfile schema 2.2.0. Change the schema to reflect the change:
+
[source, yaml]
----
# Deploy "kind" ID's use schema 2.2.0+
schemaVersion: 2.2.0
----

.. Add the `variables` section:
+
[source, yaml]
----
# Add the following variables code anywhere in devfile.yaml
# This MUST be a container registry you are able to access
variables:
  CONTAINER_IMAGE: quay.io/MYUSERNAME/nodejs-odo-example
  RESOURCE_NAME: my-nodejs-app
  CONTAINER_PORT: "3000"
  DOMAIN_NAME: nodejs.example.com
----

include::snippets/odo-deploy-commands.adoc[]
include::snippets/odo-deploy-resources.adoc[]
include::snippets/odo-deploy-route.adoc[]

. *Run the odo deploy command:*
+
.Sample command
[source,terminal]
----
$ oc deploy
----
+
.Sample output
[source,terminal]
----
  __
 /  \__     Deploying the application using my-nodejs-app Devfile
 \__/  \    Namespace: default
 /  \__/    odo version: v3.0.0-alpha2
 \__/

↪ Building & Pushing Container: MYUSERNAME/nodejs-odo-example
 •  Building image locally  ...
 ✓  Building image locally [880ms]
 •  Pushing image to container registry  ...
 ✓  Pushing image to container registry [5s]

↪ Deploying Kubernetes Component: nodejs-example
 ✓  Searching resource in cluster
 ✓  Creating kind Deployment [48ms]

↪ Deploying Kubernetes Component: nodejs-example
 ✓  Searching resource in cluster
 ✓  Creating kind Service [51ms]

↪ Deploying Kubernetes Component: nodejs-example
 ✓  Searching resource in cluster
 ✓  Creating kind Ingress [49ms]

Your Devfile has been successfully deployed
----
+
[NOTE]
====
Depending on the image registry in the `devfile.yaml`, the access for the container image
pushed by `odo deploy` may be private by default. For example, for images pushed to link:https://quay.io[Quay.io], you might need to change the image visibility appropriately to run `odo deploy` successfully.
====
+
To test your application, visit the location from the `DOMAIN_NAME` variable in the `devfile.yaml`.
//+
//Use the `oc get routes` command to find the route URL. `odo` does not currently support retrieving the route.
//+
//.Sample command
//[source,terminal]
//----
//$ oc get routes
//----
//+
//.Sample output
//[source,terminal]
//----
//TODO
//----

